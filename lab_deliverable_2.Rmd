---
title: "Lab_deliverable_2"
author: "Yihang Duanmu, Minjun Kim, Annelise Schreiber"
date: "2025-10-02"
output:
  pdf_document: default
  word_document: default
  html_document: default
header-includes:
  - \usepackage{fvextra}
  - \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,fontsize=\scriptsize,commandchars=\\\{\}}
  - \DefineVerbatimEnvironment{verbatim}{Verbatim}{breaklines,fontsize=\scriptsize}
---
## Part 1
The three questions of interest remain the same for us, they are:

1. Does the date and time in which a post is made impact the engagement that said post receives?

2. Does the fact of a post being paid/unpaid impact the average reach of the post significantly?

3. Does the cosmetics brand gain significant exposure over the course of the year, from first to latest post analyzed in 2014?

## Part 2

First, we standardize and clean the data.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=5, fig.height=3, fig.align="center")
```

```{r packages, include=FALSE, message=FALSE, warning=FALSE}
library(tidyverse); library(broom); library(kableExtra); library(here); library(janitor); library(lubridate); library(readr); library(dplyr); library(emmeans); library(ggplot2); library(patchwork)
```

```{r load data, include=FALSE}
fb_raw <- readr::read_delim("dataset_Facebook.csv", delim = ";", show_col_types = FALSE)

fb <- fb_raw |>
  janitor::clean_names() |>
  mutate(
    post_month   = suppressWarnings(as.integer(post_month)),
    post_weekday = suppressWarnings(as.integer(post_weekday)),
    post_hour    = suppressWarnings(as.integer(post_hour)),
    paid         = if_else(is.na(paid), 0L, as.integer(paid)),
    lifetime_post_consumers = as.numeric(lifetime_post_consumers)
  )
```

All the post_weekday, post_hour, and post_month data are turned to integers with non-numeric text being turned into NA. Then, wday_fac maps weekday codes from 1-7 to "Mon"–"Sun"; hour_fac turns hours into an ordered 0–23 factor; and month_fac maps 1–12 to "Jan"–"Dec" (or falls back to whatever strings exist).

```{r feature engineering, include=FALSE}
fb2 <- fb |>
  mutate(
    post_weekday_num = post_weekday,
    post_hour_num    = post_hour,
    post_month_num   = post_month
  )

# Weekday factor (1–7 expected)
wk_labels <- c("Mon","Tue","Wed","Thu","Fri","Sat","Sun")
if (all(!is.na(fb2$post_weekday_num)) && all(fb2$post_weekday_num %in% 1:7)) {
  wday_fac <- factor(fb2$post_weekday_num, levels = 1:7, labels = wk_labels, ordered = TRUE)
} else {
  # fallback if strings slipped through
  wday_fac <- factor(as.character(fb$post_weekday), ordered = TRUE)
}

# Hour factor: detect actual range (handles 0–23 or 1–23)
hour_levels <- sort(unique(fb2$post_hour_num[!is.na(fb2$post_hour_num)]))
hour_fac <- factor(fb2$post_hour_num, levels = hour_levels, ordered = TRUE)

# Month factor (1–12 -> Jan..Dec)
if (all(!is.na(fb2$post_month_num)) && all(fb2$post_month_num %in% 1:12)) {
  month_fac <- factor(fb2$post_month_num, levels = 1:12, labels = month.abb, ordered = TRUE)
} else {
  month_fac <- factor(fb$post_month, ordered = TRUE)
}

# Paid flag as tidy factor
paid_fac <- factor(if_else(is.na(fb$paid) | fb$paid == 0, "Unpaid", "Paid"),
                   levels = c("Unpaid","Paid"))
```

Then we build the analysis tibble dat—it picks the response variables (post consumers) and the cleaned timing predictors (wday, hour, month), adds the promotion flag (paid or unpaid), and creates a simple time-order index (idx). The summary(dat\$consumers) line quickly checks the outcome’s distribution; the output shows a right-skewed variable with large upper outliers, which motivates options like log1p(consumers) or robust SEs in later models.

```{r build-dat, echo=FALSE}
dat <- tibble(
  consumers = fb$lifetime_post_consumers,
  paid = paid_fac,
  wday = wday_fac,
  hour= hour_fac,
  month = month_fac,
  idx = seq_len(nrow(fb))
)
summary(dat$consumers)
```

------------------------------------------------------------------------

### Question 1: Does the date and time in which a post is made impact the engagement that said post receives?

We used the posted hours and posted weekdates as two seperate covariates. And we used log1p(consumers) as the response variable because engagement counts are extremely right-skewed with a few huge outliers, which compresses most points near zero on the raw scale and can overly influence the fit. The following plots show the distribution of the data points.

```{r Q1_regression, message=FALSE}
# Hour plot
plot_df <- dat |> mutate(hour_num = as.numeric(as.character(hour)))
p1 <- ggplot(plot_df, aes(x = hour_num, y = log1p(consumers))) +
  geom_point(shape = 1, alpha = 0.45, size = 1.2,
             position = position_jitter(width = 0.25, height = 0)) +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(title = "Engagement vs Hour of Day",
       x = "Hour (0–23)", y = "log(1 + Consumers)") +
  theme_minimal()

# Weekday plot
wk_map <- setNames(1:7, c("Mon","Tue","Wed","Thu","Fri","Sat","Sun"))
plot_df2 <- dat |> mutate(wday_num = unname(wk_map[as.character(wday)]))
p2 <- ggplot(plot_df2, aes(x = wday_num, y = log1p(consumers))) +
  geom_point(shape = 1, alpha = 0.45, size = 1.2,
             position = position_jitter(width = 0.15, height = 0)) +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  scale_x_continuous(breaks = 1:7, labels = names(wk_map)) +
  labs(title = "Engagement vs Weekday",
       x = "Weekday", y = "log(1 + Consumers)") +
  theme_minimal()

p1 + p2
```

The point plot of log1p(consumers) vs hour shows a very slight upward slope, indicating a weak tendency for engagement to be higher at later hours.

The point plot of log1p(consumers) by weekday shows an almost flat best-fit line, with similar clouds of points for Mon–Sun.

The two OLS outputs are similar so we take the OLS output for fitting post consumers to post hour as an example:

```{r}
# OLS: engagement vs hour
model_hour <- lm(log1p(consumers) ~ hour_num, data = plot_df)
summary(model_hour)
```

The result shows slight linear relationship between post consumers and post date and time. However, the p-value shows that the results are not significant, meaning the model can be improved.

### Question 2: Does the fact of a post being paid/unpaid impact the average reach of the post significantly?

To analyze whether a post being paid or unpaid impacts reach, we have:

Response variable (Y): "consumers" - This represents lifetime post consumers, a numerical value. Covariate (X): "paid" - This is a binary variable (e.g., 1 for paid posts, 0 for unpaid). It allows us to compare the average reach between the two groups.

Since we want to see whether paid status impacts average reach, a linear model is appropriate with paid status as the independent variable, and lifetime consumers as teh response. This variable was used to represent reach as we felt the number of consumers of a post best represented overall reach.

Once again, using log1p(consumers) to negate the impact of outliers.

```{r Question 2 Task 2}

ggplot(dat, aes(x = paid, y = log1p(consumers))) +
  geom_point(shape = 1, alpha = 0.45, size = 1.2, position = position_jitter(width = 0.25,   height = 0)) +
  labs(title = "Consumers vs Paid Status",
       x = "Paid Status (0 = Unpaid, 1 = Paid)",
       y = "Consumers") +
  theme_minimal()

```

There seems to be a very slight upward trend in reach as a result of posts being paid.

```{r Question 2 Task 3}

# Basic OLS model
model <- lm(log1p(consumers) ~ paid, data = dat)
summary(model)

```

We can interpret these results from the OLS model...

The intercept is the average number of log1p(consumers) for unpaid posts. The paid coefficient is the average additional reach for paid posts as compared to unpaid.

Intercept: \~6.25, which would be \~517 consumers after back transforming. Paid Coefficient: \~114 more consumers for paid posts (after back transforming) Since the p-value of 0.0265 is less than 0.05, the difference between paid and unpaid is statistically significant. As the t-value of 2.225 is greater than 2, it is also likely that the difference is statistically significant.

```{r Question 2 Task 4, message=FALSE}
dat$paid_numeric <- as.numeric(dat$paid) - 1

ggplot(dat, aes(x = paid_numeric, y = log1p(consumers))) +
  geom_point(shape = 1, alpha = 0.45, size = 1.2,
    position = position_jitter(width = 0.25, height = 0)
  ) + geom_smooth(method = "lm", se = FALSE, color = "blue", linewidth = 1.2) + 
  labs(
    title = "Consumers vs Paid Status",
    x = "Paid Status (0 = Unpaid, 1 = Paid)",
    y = "log(1 + Consumers)"
  ) +
  theme_minimal()
```

This model determines that there is an impact on reach based on paid status; however, it is not necessarily the strongest factor as the R\^2 value is so small. This likely indicates that the variation in the response variable is due more largely to other factors than whether or not a post was paid.

### Question 3: Does the cosmetics brand gain significant exposure over the course of the year, from first to latest post analyzed in 2014?

The response variable is still the post consumers and the covariate chosen is the post month. An OLS analysis on these two variables can show whether the posts reach more people as time progresses in the year. log1p(consumers) is chosen as the dependent variable to negate the impact of outliers.

```{r Question 3 fit, message=FALSE}
plot_df2 <- dat |> dplyr::mutate(mon_num = match(as.character(month), month.abb))
ggplot(plot_df2, aes(x = mon_num, y = log1p(consumers))) +
  geom_point(shape = 1, alpha = 0.45, size = 1.2,
             position = position_jitter(width = 0.15, height = 0)) +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  scale_x_continuous(breaks = 1:12, labels = month.abb) +   
  labs(title = "Exposure vs Month", x = "Month", y = "log(1 + Consumers)") +
  theme_minimal()
```

The scatter plot and the fitted regression line shows a slight downward trend. This contradicts our assumption and suggests the brand gradually loses exposure throughout 2014.

```{r Question 3 summary, message=FALSE}
model_month <- lm(log1p(consumers) ~ mon_num, data = plot_df2)
summary(model_month)
```

The negative coefficient confirms the negative relationship between exposure and months. The low p-value suggests that the linear model is significant but the low R^2 value indicates high variation in the data.

##Lab 3: Question 2

Question: Does the time that a post is made during the day, coupled with the post being paid or not, impact the reach that a post gets?

Response variable (Y): "consumers"
  - This represents lifetime post consumers, a numerical value.
  
Covariates: 
"paid"
  - This is a binary variable (e.g., 1 for paid posts, 0 for unpaid). It allows us to compare the average reach between the two groups.
"post_hour"
  - This variable represents the time of day a post was made.

Since we want to see whether the hour of a post and paid status impacts average reach, a multiple linear regression model is appropriate with paid status and post hour as the independent variables, and lifetime consumers as the response. This variable was used to represent reach as we felt the number of consumers of a post best represented overall reach.

```{r Lab 3}

dat$paid <- as.numeric(dat$paid)
dat$hour <- as.numeric(as.character(dat$hour))
model <- lm(log1p(consumers) ~ paid + hour, data = dat)

pred_dat <- expand.grid(
  paid = c(0, 1),
  hour = seq(min(dat$hour), max(dat$hour), length.out = 50)
)

pred_dat$pred <- predict(model, newdata = pred_dat)

ggplot(dat, aes(x = hour, y = log1p(consumers), color = factor(paid))) +
  geom_point(alpha = 0.4, size = 1) +
  geom_line(data = pred_dat, aes(y = pred, color = factor(paid)), size = 1.2) +
  labs(
    title = "Predicted Consumers by Paid Status and Post Hour",
    x = "Post Hour",
    y = "Log(Consumers + 1)",
    color = "Paid Status"
  ) +
  scale_color_manual(values = c("0" = "#1f77b4", "1" = "#ff7f0e"),
                     labels = c("Unpaid", "Paid")) +
  theme_minimal()

```

Multiple Linear Regression Model:
log(Consumersi+1)=β0+β1(Paidi)+β2(Houri)+εi
β1 represents the expected change in the response as a result of a post being paid as opposed to unpaid; β0 represents the expected change in the response as the result of each added hour in the day that a post is made.

Assumptions: linear relationships between the predictors and the response; independent observations; constant variance of residuals; and normally distributed errors.

```{r Lab 3 pt 2}

  summary(model)

```
From this data, we're able to have some insight on the research question. It seems as though the influence of a post being paid or not is statistically significant regarding a post's reach, but the hour in which the post is made is not significant. From the adjusted R squared value of 0.009859, we can tell that only about 0.9895% of the variance in log consumers can be accounted for by theses factors--other factors are likely to be more influential.

Illustration of Model Fit:
```{r Lab 3 pt 3}

#Residuals vs Fitted

library(ggplot2)
library(broom)

resid_df <- augment(model)

ggplot(resid_df, aes(.fitted, .resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(x = "Fitted Values", y = "Residuals", title = "Residuals vs Fitted") +
  theme_minimal()

#QQ Plot

ggplot(resid_df, aes(sample = .resid)) +
  stat_qq() +
  stat_qq_line() +
  labs(title = "Normal Q-Q Plot") +
  theme_minimal()

```
From these graphs, can see that the normality assumption generally holds except at the tails where there seems to be outliers. From the residuals vs fitted graph we can see that linearity holds as the points are approximately scattered about 0 without a clear pattern.

## Author Contribution Statement
1. **First Deliverable**
   1. **Yihang Duanmu** — insight for the motivation section
   2. **Minjun Kim** — introduction/summary
   3. **Annelise Schreiber** — questions/impact; editing

2. **Second Deliverable**
   1. **Yihang Duanmu** — OLS analysis for Question 3
   2. **Minjun Kim** — OLS analysis for Question 1
   3. **Annelise Schreiber** — OLS analysis for Question 2

